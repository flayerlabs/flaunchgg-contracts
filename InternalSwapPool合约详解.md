# InternalSwapPool.sol åˆçº¦è¯¦è§£

## ğŸ“š ç›®å½•

1. [InternalSwapPool æ ¸å¿ƒæ¦‚å¿µ](#internalswappool-æ ¸å¿ƒæ¦‚å¿µ)
2. [ä¸ºä»€ä¹ˆéœ€è¦å†…éƒ¨äº¤æ¢æ± ï¼Ÿ](#ä¸ºä»€ä¹ˆéœ€è¦å†…éƒ¨äº¤æ¢æ± )
3. [è®¾è®¡æ€æƒ³ä¸æ¶æ„](#è®¾è®¡æ€æƒ³ä¸æ¶æ„)
4. [åˆçº¦ç»“æ„è§£æ](#åˆçº¦ç»“æ„è§£æ)
5. [æ ¸å¿ƒå‡½æ•°è¯¦è§£](#æ ¸å¿ƒå‡½æ•°è¯¦è§£)
6. [å†…éƒ¨äº¤æ¢æœºåˆ¶æ·±å…¥ç†è§£](#å†…éƒ¨äº¤æ¢æœºåˆ¶æ·±å…¥ç†è§£)
7. [å®Œæ•´å·¥ä½œæµç¨‹](#å®Œæ•´å·¥ä½œæµç¨‹)
8. [ä»£ç ç¤ºä¾‹ä¸å›¾è§£](#ä»£ç ç¤ºä¾‹ä¸å›¾è§£)

---

## InternalSwapPool æ ¸å¿ƒæ¦‚å¿µ

### ä»€ä¹ˆæ˜¯ InternalSwapPoolï¼ˆå†…éƒ¨äº¤æ¢æ± ï¼‰ï¼Ÿ

**InternalSwapPool** æ˜¯ä¸€ä¸ª**å‰ç½®äº¤æ¢æœºåˆ¶**ï¼Œåœ¨äº¤æ˜“åˆ°è¾¾ Uniswap ä¸»æ± ä¹‹å‰ï¼Œä½¿ç”¨ç´¯ç§¯çš„è´¹ç”¨ä»£å¸æ¥å¡«å……éƒ¨åˆ†äº¤æ¢éœ€æ±‚ã€‚

### æ ¸å¿ƒç‰¹ç‚¹

1. **å‰ç½®å¡«å……**ï¼šåœ¨ Uniswap äº¤æ¢ä¹‹å‰å¤„ç†éƒ¨åˆ†éœ€æ±‚
2. **å‡å°‘å†²å‡»**ï¼šé™ä½å¯¹ä¸»æ± çš„ä»·æ ¼å½±å“
3. **Gas ä¼˜åŒ–**ï¼šå†…éƒ¨å¤„ç†æ¯”æ± å†…äº¤æ¢æ›´çœ gas
4. **è®¢å•ç°¿åŠŸèƒ½**ï¼šä½œä¸ºéƒ¨åˆ†è®¢å•ç°¿ï¼Œå¹³æ»‘ä»·æ ¼æ³¢åŠ¨

### å·¥ä½œåŸç†ç¤ºæ„å›¾

```
æ­£å¸¸æµç¨‹ï¼ˆæ—  InternalSwapPoolï¼‰ï¼š
ç”¨æˆ·æƒ³ä¹° 100 Token
    â†“
ç›´æ¥è¿›å…¥ Uniswap æ± 
    â†“
æ¶ˆè€—æ± çš„æµåŠ¨æ€§ï¼Œå½±å“ä»·æ ¼

ä½¿ç”¨ InternalSwapPoolï¼š
ç”¨æˆ·æƒ³ä¹° 100 Token
    â†“
InternalSwapPool æ£€æŸ¥è´¹ç”¨æ± 
    â”œâ”€ æœ‰ 50 Token è´¹ç”¨å¯ç”¨
    â””â”€ ä»è´¹ç”¨ä¸­æä¾› 50 Token
    â†“
å‰©ä½™ 50 Token è¿›å…¥ Uniswap æ± 
    â†“
å‡å°‘å¯¹ä¸»æ± çš„å½±å“
```

---

## ä¸ºä»€ä¹ˆéœ€è¦å†…éƒ¨äº¤æ¢æ± ï¼Ÿ

### é—®é¢˜ 1: ä»·æ ¼å†²å‡»ï¼ˆPrice Impactï¼‰

**é—®é¢˜**ï¼š
- å¤§é¢äº¤æ˜“ä¼šæ˜¾è‘—å½±å“æ± çš„ä»·æ ¼
- å¯¼è‡´æ»‘ç‚¹å¢åŠ ï¼Œç”¨æˆ·ä½“éªŒå·®
- å¯¹æ± çš„æµåŠ¨æ€§é€ æˆå‹åŠ›

**è§£å†³æ–¹æ¡ˆ**ï¼š
- ä½¿ç”¨ç´¯ç§¯çš„è´¹ç”¨ä»£å¸å‰ç½®å¡«å……
- å‡å°‘å®é™…è¿›å…¥ä¸»æ± çš„äº¤æ˜“é‡
- é™ä½ä»·æ ¼å†²å‡»

### é—®é¢˜ 2: Gas æˆæœ¬

**é—®é¢˜**ï¼š
- æ¯æ¬¡äº¤æ¢éƒ½éœ€è¦ä¸ Uniswap æ± äº¤äº’
- æ¶‰åŠå¤æ‚çš„æµåŠ¨æ€§è®¡ç®—
- Gas æ¶ˆè€—è¾ƒé«˜

**è§£å†³æ–¹æ¡ˆ**ï¼š
- å†…éƒ¨äº¤æ¢æ›´ç®€å•ï¼ŒGas æ¶ˆè€—æ›´ä½
- å‡å°‘å¯¹ä¸»æ± çš„è°ƒç”¨æ¬¡æ•°

### é—®é¢˜ 3: è´¹ç”¨ä»£å¸å¤„ç†

**é—®é¢˜**ï¼š
- äº¤æ˜“æ‰‹ç»­è´¹ä»¥ Memecoin å½¢å¼ç´¯ç§¯
- éœ€è¦è½¬æ¢ä¸º ETH æ‰èƒ½åˆ†é…
- ç›´æ¥æŠ›å”®ä¼šå¯¹ä»·æ ¼é€ æˆè´Ÿé¢å½±å“

**è§£å†³æ–¹æ¡ˆ**ï¼š
- åœ¨ç”¨æˆ·è´­ä¹°æ—¶æä¾› Memecoin
- è‡ªç„¶è½¬æ¢ä¸º ETHï¼Œæ— éœ€é¢å¤–æŠ›å”®
- å¯¹ä»·æ ¼å½±å“æœ€å°

### ç±»æ¯”ç†è§£

**ä¼ ç»Ÿè®¢å•ç°¿äº¤æ˜“æ‰€**ï¼š
```
è®¢å•ç°¿ï¼š
â”œâ”€ ä¹°å• 1: 100 Token @ 1.0 ETH
â”œâ”€ ä¹°å• 2: 50 Token @ 0.99 ETH
â””â”€ ä¹°å• 3: 30 Token @ 0.98 ETH

ç”¨æˆ·å–å‡º 150 Token
    â†“
åŒ¹é…è®¢å• 1, 2, 3
    â†“
ä»·æ ¼å½±å“è¾ƒå°
```

**InternalSwapPoolï¼ˆç±»ä¼¼è®¢å•ç°¿ï¼‰**ï¼š
```
è´¹ç”¨æ± ï¼š
â””â”€ ç´¯ç§¯çš„ Memecoin è´¹ç”¨

ç”¨æˆ·è´­ä¹° Memecoin
    â†“
ä»è´¹ç”¨æ± ä¸­æä¾›éƒ¨åˆ†ä»£å¸
    â†“
å‡å°‘å¯¹ä¸»æ± çš„éœ€æ±‚
    â†“
ä»·æ ¼å½±å“è¾ƒå°
```

---

## è®¾è®¡æ€æƒ³ä¸æ¶æ„

### æ ¸å¿ƒè®¾è®¡åŸåˆ™

1. **å‰ç½®å¤„ç†**ï¼šåœ¨ Uniswap äº¤æ¢ä¹‹å‰å¤„ç†
2. **éƒ¨åˆ†å¡«å……**ï¼šåªå¡«å……éƒ¨åˆ†éœ€æ±‚ï¼Œä¸å…¨éƒ¨æ»¡è¶³
3. **ä»·æ ¼åŒ¹é…**ï¼šä½¿ç”¨å½“å‰æ± çš„ä»·æ ¼è¿›è¡Œè®¡ç®—
4. **è‡ªåŠ¨è½¬æ¢**ï¼šMemecoin è´¹ç”¨è‡ªåŠ¨è½¬æ¢ä¸º ETH

### å·¥ä½œæ—¶æœº

```
äº¤æ˜“æµç¨‹ï¼š
    â†“
PositionManager.beforeSwap()
    â†“
1. å¤„ç† FairLaunchï¼ˆå¦‚æœåœ¨å…¬å¹³å¯åŠ¨æœŸé—´ï¼‰
    â†“
2. å¤„ç† InternalSwapPool â† è¿™é‡Œ
    â”œâ”€ æ£€æŸ¥æ˜¯å¦æœ‰ token1 è´¹ç”¨
    â”œâ”€ æ£€æŸ¥äº¤æ¢æ–¹å‘ï¼ˆå¿…é¡»æ˜¯ ETH -> Tokenï¼‰
    â””â”€ ä»è´¹ç”¨ä¸­æä¾›éƒ¨åˆ†ä»£å¸
    â†“
3. Uniswap V4 æ‰§è¡Œå‰©ä½™äº¤æ¢
    â†“
4. PositionManager.afterSwap()
```

### å…³é”®é™åˆ¶

**åªå¤„ç† ETH -> Token çš„äº¤æ¢**ï¼š
```solidity
// åªå¤„ç†è´­ä¹° Memecoin çš„æƒ…å†µ
if (_nativeIsZero != _params.zeroForOne) {
    return;  // ä¸å¤„ç† Token -> ETH çš„äº¤æ¢
}
```

**åŸå› **ï¼š
- è´¹ç”¨æ± ä¸­ç´¯ç§¯çš„æ˜¯ Memecoinï¼ˆtoken1ï¼‰
- åªæœ‰åœ¨ç”¨æˆ·è´­ä¹° Memecoin æ—¶æ‰èƒ½ä½¿ç”¨
- ç”¨æˆ·å–å‡ºæ—¶ä¸éœ€è¦å‰ç½®å¡«å……

---

## åˆçº¦ç»“æ„è§£æ

### æ•°æ®ç»“æ„

#### ClaimableFees

```solidity
struct ClaimableFees {
    uint amount0;  // ETH ç­‰ä»·çš„ä»£å¸æ•°é‡
    uint amount1; // Memecoin æ•°é‡
}
```

**å­—æ®µè¯´æ˜**ï¼š

- `amount0`: ç´¯ç§¯çš„ ETH ç­‰ä»·ä»£å¸ï¼ˆflETHï¼‰
- `amount1`: ç´¯ç§¯çš„ Memecoin ä»£å¸

**é‡è¦ç†è§£**ï¼š
- `amount0` å’Œ `amount1` çš„æ˜ å°„å–å†³äº `PoolKey` ä¸­ä»£å¸çš„é¡ºåº
- ä½†é€»è¾‘ä¸Šï¼Œ`amount0` æ€»æ˜¯ ETHï¼Œ`amount1` æ€»æ˜¯ Memecoin

### å­˜å‚¨æ˜ å°„

```solidity
mapping (PoolId _poolId => ClaimableFees _fees) internal _poolFees;
```

æ¯ä¸ªæ± éƒ½æœ‰ç‹¬ç«‹çš„è´¹ç”¨ç´¯ç§¯ã€‚

---

## æ ¸å¿ƒå‡½æ•°è¯¦è§£

### 1. _depositFees() - å­˜å…¥è´¹ç”¨

#### å‡½æ•°ç­¾å

```solidity
function _depositFees(PoolKey memory _poolKey, uint _amount0, uint _amount1) internal
```

#### åŠŸèƒ½è¯´æ˜

å°†æ•è·çš„æ‰‹ç»­è´¹å­˜å…¥è´¹ç”¨æ± ï¼Œç­‰å¾…åç»­ä½¿ç”¨ã€‚

#### æ‰§è¡Œæµç¨‹

```solidity
PoolId _poolId = _poolKey.toId();

// ç´¯ç§¯è´¹ç”¨
_poolFees[_poolId].amount0 += _amount0;  // ETH
_poolFees[_poolId].amount1 += _amount1;  // Memecoin

emit PoolFeesReceived(_poolId, _amount0, _amount1);
```

#### å…³é”®ç†è§£

**ä»€ä¹ˆæ—¶å€™è°ƒç”¨ï¼Ÿ**

åœ¨ `PositionManager._captureAndDepositFees()` ä¸­è°ƒç”¨ï¼š

```solidity
// æ•è·æ‰‹ç»­è´¹å
_depositFees(
    _key,
    Currency.unwrap(swapFeeCurrency) == nativeToken ? swapFee_ - referrerFee : 0,
    Currency.unwrap(swapFeeCurrency) == nativeToken ? 0 : swapFee_ - referrerFee
);
```

**è´¹ç”¨æ¥æº**ï¼š
- ä»äº¤æ˜“ä¸­æ•è·çš„æ‰‹ç»­è´¹
- æ¨èäººè´¹ç”¨å·²æå‰åˆ†é…ï¼Œå‰©ä½™éƒ¨åˆ†å­˜å…¥è´¹ç”¨æ± 

---

### 2. _internalSwap() - å†…éƒ¨äº¤æ¢æ ¸å¿ƒé€»è¾‘

#### å‡½æ•°ç­¾å

```solidity
function _internalSwap(
    IPoolManager _poolManager,
    PoolKey calldata _key,
    IPoolManager.SwapParams memory _params,
    bool _nativeIsZero
) internal returns (
    uint ethIn_,
    uint tokenOut_
)
```

#### åŠŸèƒ½è¯´æ˜

è¿™æ˜¯**å†…éƒ¨äº¤æ¢çš„æ ¸å¿ƒå‡½æ•°**ï¼Œæ£€æŸ¥æ˜¯å¦å¯ä»¥ç”¨è´¹ç”¨ä»£å¸å¡«å……éƒ¨åˆ†äº¤æ¢éœ€æ±‚ã€‚

#### æ‰§è¡Œæµç¨‹è¯¦è§£

##### æ­¥éª¤ 1: æ£€æŸ¥æ˜¯å¦æœ‰å¯ç”¨è´¹ç”¨

```solidity
ClaimableFees storage pendingPoolFees = _poolFees[poolId];

// å¦‚æœæ²¡æœ‰ token1ï¼ˆMemecoinï¼‰è´¹ç”¨ï¼Œæ— æ³•è¿›è¡Œå†…éƒ¨äº¤æ¢
if (pendingPoolFees.amount1 == 0) {
    return (ethIn_, tokenOut_);
}
```

**å…³é”®ç†è§£**ï¼š
- åªæ£€æŸ¥ `amount1`ï¼ˆMemecoinï¼‰
- å› ä¸ºå†…éƒ¨äº¤æ¢æ˜¯ç”¨ Memecoin æä¾›ä»£å¸ç»™ç”¨æˆ·

##### æ­¥éª¤ 2: æ£€æŸ¥äº¤æ¢æ–¹å‘

```solidity
// åªå¤„ç† ETH -> Token çš„äº¤æ¢ï¼ˆç”¨æˆ·è´­ä¹° Memecoinï¼‰
if (_nativeIsZero != _params.zeroForOne) {
    return (ethIn_, tokenOut_);
}
```

**é€»è¾‘è§£é‡Š**ï¼š

- `_nativeIsZero = true`ï¼šETH æ˜¯ currency0
- `_params.zeroForOne = true`ï¼šç”¨ currency0 æ¢ currency1ï¼ˆETH -> Tokenï¼‰
- æ¡ä»¶ï¼š`true != true` = `false`ï¼Œä¸è¿”å›ï¼Œç»§ç»­å¤„ç†

- `_nativeIsZero = false`ï¼šETH æ˜¯ currency1
- `_params.zeroForOne = false`ï¼šç”¨ currency1 æ¢ currency0ï¼ˆETH -> Tokenï¼‰
- æ¡ä»¶ï¼š`false != false` = `false`ï¼Œä¸è¿”å›ï¼Œç»§ç»­å¤„ç†

**æ€»ç»“**ï¼šåªæœ‰å½“ç”¨æˆ·ç”¨ ETH è´­ä¹° Memecoin æ—¶æ‰å¤„ç†ã€‚

##### æ­¥éª¤ 3: è·å–å½“å‰ä»·æ ¼

```solidity
(uint160 sqrtPriceX96,,,) = _poolManager.getSlot0(poolId);
```

ä½¿ç”¨å½“å‰æ± çš„ä»·æ ¼æ¥è®¡ç®—äº¤æ¢ï¼Œç¡®ä¿ä»·æ ¼ä¸€è‡´ã€‚

##### æ­¥éª¤ 4: å¤„ç†æ­£æ•° amountSpecifiedï¼ˆæŒ‡å®š Token æ•°é‡ï¼‰

```solidity
if (_params.amountSpecified >= 0) {
    // ç”¨æˆ·æŒ‡å®šè¦è´­ä¹°å¤šå°‘ Token
    // å–è¾ƒå°å€¼ï¼šç”¨æˆ·éœ€æ±‚ vs å¯ç”¨è´¹ç”¨
    uint amountSpecified = (uint(_params.amountSpecified) > pendingPoolFees.amount1)
        ? pendingPoolFees.amount1  // è´¹ç”¨ä¸è¶³ï¼Œåªèƒ½æä¾›éƒ¨åˆ†
        : uint(_params.amountSpecified);  // è´¹ç”¨å……è¶³ï¼Œæ»¡è¶³å…¨éƒ¨éœ€æ±‚

    // è®¡ç®—éœ€è¦å¤šå°‘ ETH æ¥è´­ä¹°è¿™äº› Token
    (, ethIn_, tokenOut_, ) = SwapMath.computeSwapStep({
        sqrtPriceCurrentX96: sqrtPriceX96,
        sqrtPriceTargetX96: _params.sqrtPriceLimitX96,
        liquidity: _poolManager.getLiquidity(poolId),
        amountRemaining: int(amountSpecified),
        feePips: 0  // å†…éƒ¨äº¤æ¢æ— æ‰‹ç»­è´¹
    });
}
```

**å…³é”®ç†è§£**ï¼š

- `amountSpecified >= 0`ï¼šç”¨æˆ·æŒ‡å®šè¦è´­ä¹°å¤šå°‘ Token
- ä¾‹å¦‚ï¼šç”¨æˆ·æƒ³ä¹° 100 Token
- å¦‚æœè´¹ç”¨æ± æœ‰ 50 Tokenï¼Œåªèƒ½æä¾› 50 Token
- è®¡ç®—éœ€è¦å¤šå°‘ ETH æ¥è´­ä¹°è¿™äº› Token

##### æ­¥éª¤ 5: å¤„ç†è´Ÿæ•° amountSpecifiedï¼ˆæŒ‡å®š ETH æ•°é‡ï¼‰

```solidity
else {
    // ç”¨æˆ·æŒ‡å®šè¦èŠ±è´¹å¤šå°‘ ETH
    // è®¡ç®—èƒ½è·å¾—å¤šå°‘ Token
    (, tokenOut_, ethIn_, ) = SwapMath.computeSwapStep({
        sqrtPriceCurrentX96: sqrtPriceX96,
        sqrtPriceTargetX96: _params.zeroForOne 
            ? TickMath.MAX_SQRT_PRICE - 1 
            : TickMath.MIN_SQRT_PRICE + 1,
        liquidity: _poolManager.getLiquidity(poolId),
        amountRemaining: int(-_params.amountSpecified),
        feePips: 0
    });

    // å¦‚æœè®¡ç®—å‡ºçš„ Token æ•°é‡è¶…è¿‡å¯ç”¨è´¹ç”¨
    if (tokenOut_ > pendingPoolFees.amount1) {
        // æŒ‰æ¯”ä¾‹å‡å°‘ ETH è¾“å…¥
        ethIn_ = (pendingPoolFees.amount1 * ethIn_) / tokenOut_;
        tokenOut_ = pendingPoolFees.amount1;  // é™åˆ¶ä¸ºå¯ç”¨è´¹ç”¨
    }
}
```

**å…³é”®ç†è§£**ï¼š

- `amountSpecified < 0`ï¼šç”¨æˆ·æŒ‡å®šè¦èŠ±è´¹å¤šå°‘ ETH
- ä¾‹å¦‚ï¼šç”¨æˆ·æƒ³èŠ± 1 ETH è´­ä¹° Token
- è®¡ç®—èƒ½è·å¾—å¤šå°‘ Token
- å¦‚æœè¶…è¿‡å¯ç”¨è´¹ç”¨ï¼ŒæŒ‰æ¯”ä¾‹å‡å°‘

**ä¸ºä»€ä¹ˆåè½¬ sqrtPriceTargetX96ï¼Ÿ**

- `computeSwapStep` è®¡ç®—çš„æ˜¯ä»å½“å‰ä»·æ ¼åˆ°ç›®æ ‡ä»·æ ¼çš„äº¤æ¢
- æˆ‘ä»¬éœ€è¦è®¡ç®—ç›¸åæ–¹å‘ï¼ˆETH -> Tokenï¼‰
- å› æ­¤ä½¿ç”¨æå€¼ä»·æ ¼ä½œä¸ºç›®æ ‡

##### æ­¥éª¤ 6: æ›´æ–°è´¹ç”¨æ± 

```solidity
// å¢åŠ  ETHï¼ˆä»ç”¨æˆ·é‚£é‡Œè·å¾—ï¼‰
pendingPoolFees.amount0 += ethIn_;

// å‡å°‘ Memecoinï¼ˆæä¾›ç»™ç”¨æˆ·ï¼‰
pendingPoolFees.amount1 -= tokenOut_;
```

**å…³é”®ç†è§£**ï¼š

- ç”¨æˆ·æ”¯ä»˜ ETHï¼Œè·å¾— Memecoin
- è´¹ç”¨æ± ï¼šETH å¢åŠ ï¼ŒMemecoin å‡å°‘
- è¿™ç›¸å½“äºå°† Memecoin è´¹ç”¨è½¬æ¢ä¸º ETH

##### æ­¥éª¤ 7: ç»“ç®—ä»£å¸

```solidity
// ä» PoolManager æå– ETHï¼ˆç”¨æˆ·æ”¯ä»˜çš„ï¼‰
_poolManager.take(
    !_nativeIsZero ? _key.currency1 : _key.currency0, 
    address(this), 
    ethIn_
);

// ç»“ç®— Memecoinï¼ˆæä¾›ç»™ç”¨æˆ·çš„ï¼‰
(!_nativeIsZero ? _key.currency0 : _key.currency1).settle(
    _poolManager, 
    address(this), 
    tokenOut_, 
    false
);
```

**å…³é”®ç†è§£**ï¼š

- `take`ï¼šä» PoolManager æå–ä»£å¸ï¼ˆç”¨æˆ·æ”¯ä»˜çš„ ETHï¼‰
- `settle`ï¼šå‘ PoolManager æ”¯ä»˜ä»£å¸ï¼ˆæä¾›ç»™ç”¨æˆ·çš„ Memecoinï¼‰
- è¿™å®Œæˆäº†ä»£å¸çš„è½¬ç§»

#### å®Œæ•´æµç¨‹å›¾

```
_internalSwap() è¢«è°ƒç”¨
    â†“
æ£€æŸ¥æ˜¯å¦æœ‰ token1 è´¹ç”¨
    â”œâ”€ æ—  â†’ è¿”å› (0, 0)
    â””â”€ æœ‰ â†’ ç»§ç»­
    â†“
æ£€æŸ¥äº¤æ¢æ–¹å‘
    â”œâ”€ Token -> ETH â†’ è¿”å› (0, 0)
    â””â”€ ETH -> Token â†’ ç»§ç»­
    â†“
è·å–å½“å‰ä»·æ ¼
    â†“
åˆ¤æ–­ amountSpecified æ­£è´Ÿ
    â”œâ”€ >= 0: æŒ‡å®š Token æ•°é‡
    â”‚   â””â”€ è®¡ç®—éœ€è¦å¤šå°‘ ETH
    â””â”€ < 0: æŒ‡å®š ETH æ•°é‡
        â””â”€ è®¡ç®—èƒ½è·å¾—å¤šå°‘ Token
    â†“
æ›´æ–°è´¹ç”¨æ± 
    â”œâ”€ amount0 += ethIn_ï¼ˆETH å¢åŠ ï¼‰
    â””â”€ amount1 -= tokenOut_ï¼ˆMemecoin å‡å°‘ï¼‰
    â†“
ç»“ç®—ä»£å¸
    â”œâ”€ take ETHï¼ˆä»ç”¨æˆ·ï¼‰
    â””â”€ settle Memecoinï¼ˆç»™ç”¨æˆ·ï¼‰
    â†“
è¿”å› (ethIn_, tokenOut_)
```

---

## å†…éƒ¨äº¤æ¢æœºåˆ¶æ·±å…¥ç†è§£

### 1. ä¸ºä»€ä¹ˆåªå¤„ç† ETH -> Tokenï¼Ÿ

**åŸå› **ï¼š

1. **è´¹ç”¨æ± å†…å®¹**ï¼šè´¹ç”¨æ± ä¸­ç´¯ç§¯çš„æ˜¯ Memecoinï¼ˆtoken1ï¼‰
2. **ä½¿ç”¨åœºæ™¯**ï¼šåªæœ‰åœ¨ç”¨æˆ·è´­ä¹° Memecoin æ—¶æ‰èƒ½ä½¿ç”¨
3. **è½¬æ¢ç›®çš„**ï¼šå°† Memecoin è´¹ç”¨è½¬æ¢ä¸º ETH

**å¦‚æœå¤„ç† Token -> ETH ä¼šæ€æ ·ï¼Ÿ**

- ç”¨æˆ·å–å‡º Memecoinï¼Œè·å¾— ETH
- è´¹ç”¨æ± éœ€è¦æä¾› ETHï¼Œä½†è´¹ç”¨æ± ä¸­ä¸»è¦æ˜¯ Memecoin
- æ— æ³•æ»¡è¶³éœ€æ±‚ï¼Œåè€Œå¢åŠ å¤æ‚åº¦

### 2. ä»·æ ¼è®¡ç®—æœºåˆ¶

#### ä½¿ç”¨ SwapMath.computeSwapStep

```solidity
SwapMath.computeSwapStep({
    sqrtPriceCurrentX96: sqrtPriceX96,      // å½“å‰ä»·æ ¼
    sqrtPriceTargetX96: targetPrice,         // ç›®æ ‡ä»·æ ¼
    liquidity: liquidity,                    // æ± çš„æµåŠ¨æ€§
    amountRemaining: amountSpecified,        // å‰©ä½™æ•°é‡
    feePips: 0                              // æ— æ‰‹ç»­è´¹
})
```

**å…³é”®å‚æ•°**ï¼š

- `sqrtPriceCurrentX96`ï¼šå½“å‰æ± çš„ä»·æ ¼
- `liquidity`ï¼šæ± çš„æµåŠ¨æ€§ï¼ˆç”¨äºè®¡ç®—ä»·æ ¼å½±å“ï¼‰
- `feePips: 0`ï¼šå†…éƒ¨äº¤æ¢æ— æ‰‹ç»­è´¹ï¼Œæ›´ä¼˜æƒ 

**ä¸ºä»€ä¹ˆä½¿ç”¨æ± çš„æµåŠ¨æ€§ï¼Ÿ**

- å³ä½¿æ˜¯ä»è´¹ç”¨æ± æä¾›ä»£å¸ï¼Œä»·æ ¼è®¡ç®—ä»åŸºäºä¸»æ± 
- ç¡®ä¿ä»·æ ¼ä¸€è‡´æ€§
- é¿å…å¥—åˆ©æœºä¼š

### 3. éƒ¨åˆ†å¡«å……æœºåˆ¶

#### åœºæ™¯ 1: è´¹ç”¨å……è¶³

```solidity
ç”¨æˆ·éœ€æ±‚: 100 Token
è´¹ç”¨æ± : 150 Token

// æ‰§è¡Œ
amountSpecified = min(100, 150) = 100 Token
// æä¾›å…¨éƒ¨ 100 Token
```

#### åœºæ™¯ 2: è´¹ç”¨ä¸è¶³

```solidity
ç”¨æˆ·éœ€æ±‚: 100 Token
è´¹ç”¨æ± : 50 Token

// æ‰§è¡Œ
amountSpecified = min(100, 50) = 50 Token
// åªæä¾› 50 Token
// å‰©ä½™ 50 Token ç”± Uniswap æ± æä¾›
```

**å…³é”®ç†è§£**ï¼š

- å†…éƒ¨äº¤æ¢åªå¡«å……**éƒ¨åˆ†**éœ€æ±‚
- å‰©ä½™éƒ¨åˆ†ç”± Uniswap æ± å¤„ç†
- è¿™æ ·æ—¢åˆ©ç”¨äº†è´¹ç”¨æ± ï¼Œåˆä¸ä¼šå®Œå…¨ç»•è¿‡ä¸»æ± 

### 4. è´¹ç”¨è½¬æ¢æœºåˆ¶

#### è½¬æ¢æµç¨‹

```
è´¹ç”¨æ± åˆå§‹çŠ¶æ€ï¼š
amount0 = 0 ETH
amount1 = 100 Tokenï¼ˆç´¯ç§¯çš„æ‰‹ç»­è´¹ï¼‰

ç”¨æˆ·è´­ä¹° 50 Tokenï¼š
    â†“
å†…éƒ¨äº¤æ¢æ‰§è¡Œ
    â”œâ”€ ç”¨æˆ·æ”¯ä»˜: 0.5 ETH
    â””â”€ ç”¨æˆ·è·å¾—: 50 Token
    â†“
è´¹ç”¨æ± æ›´æ–°ï¼š
amount0 = 0 + 0.5 = 0.5 ETH
amount1 = 100 - 50 = 50 Token
```

**æ•ˆæœ**ï¼š
- Memecoin è´¹ç”¨è‡ªåŠ¨è½¬æ¢ä¸º ETH
- æ— éœ€é¢å¤–æŠ›å”®æ“ä½œ
- å¯¹ä»·æ ¼å½±å“æœ€å°

---

## å®Œæ•´å·¥ä½œæµç¨‹

### åœºæ™¯ 1: æ­£å¸¸å†…éƒ¨äº¤æ¢æµç¨‹

```
1. ç”¨æˆ·å‘èµ·äº¤æ˜“ï¼ˆè´­ä¹° Memecoinï¼‰
   swapAmount = 100 Token
    â†“
2. PositionManager.beforeSwap()
   â”œâ”€ å¤„ç† FairLaunchï¼ˆå¦‚æœåœ¨å…¬å¹³å¯åŠ¨æœŸé—´ï¼‰
   â””â”€ è°ƒç”¨ _internalSwap()
       â”œâ”€ æ£€æŸ¥è´¹ç”¨æ± ï¼šæœ‰ 50 Token
       â”œâ”€ æ£€æŸ¥æ–¹å‘ï¼šETH -> Token âœ“
       â”œâ”€ è®¡ç®—äº¤æ¢ï¼šéœ€è¦ 0.5 ETH è´­ä¹° 50 Token
       â”œâ”€ æ›´æ–°è´¹ç”¨æ± 
       â”‚   â”œâ”€ amount0 += 0.5 ETH
       â”‚   â””â”€ amount1 -= 50 Token
       â””â”€ ç»“ç®—ä»£å¸
           â”œâ”€ take 0.5 ETHï¼ˆä»ç”¨æˆ·ï¼‰
           â””â”€ settle 50 Tokenï¼ˆç»™ç”¨æˆ·ï¼‰
    â†“
3. æ›´æ–° beforeSwapDelta
   â”œâ”€ å·²æä¾›: 50 Token
   â””â”€ å·²æ”¯ä»˜: 0.5 ETH
    â†“
4. Uniswap V4 æ‰§è¡Œå‰©ä½™äº¤æ¢
   â”œâ”€ å‰©ä½™éœ€æ±‚: 50 Token
   â””â”€ éœ€è¦æ”¯ä»˜: 0.5 ETH
    â†“
5. ç”¨æˆ·è·å¾—: 100 Tokenï¼ˆ50 + 50ï¼‰
   ç”¨æˆ·æ”¯ä»˜: 1 ETHï¼ˆ0.5 + 0.5ï¼‰
```

### åœºæ™¯ 2: è´¹ç”¨ä¸è¶³

```
1. ç”¨æˆ·å‘èµ·äº¤æ˜“ï¼ˆè´­ä¹° Memecoinï¼‰
   swapAmount = 100 Token
    â†“
2. _internalSwap()
   â”œâ”€ æ£€æŸ¥è´¹ç”¨æ± ï¼šåªæœ‰ 30 Token
   â”œâ”€ è®¡ç®—ï¼šåªèƒ½æä¾› 30 Token
   â””â”€ æ›´æ–°è´¹ç”¨æ± 
       â”œâ”€ amount0 += 0.3 ETH
       â””â”€ amount1 -= 30 Token
    â†“
3. Uniswap å¤„ç†å‰©ä½™ 70 Token
    â†“
4. ç”¨æˆ·è·å¾—: 100 Tokenï¼ˆ30 + 70ï¼‰
```

### åœºæ™¯ 3: æ— å¯ç”¨è´¹ç”¨

```
1. ç”¨æˆ·å‘èµ·äº¤æ˜“
    â†“
2. _internalSwap()
   â”œâ”€ æ£€æŸ¥è´¹ç”¨æ± ï¼šamount1 = 0
   â””â”€ è¿”å› (0, 0)
    â†“
3. å…¨éƒ¨ç”± Uniswap å¤„ç†
```

### åœºæ™¯ 4: é”™è¯¯æ–¹å‘ï¼ˆToken -> ETHï¼‰

```
1. ç”¨æˆ·å–å‡º Memecoin
    â†“
2. _internalSwap()
   â”œâ”€ æ£€æŸ¥æ–¹å‘ï¼šToken -> ETH
   â””â”€ è¿”å› (0, 0)ï¼ˆä¸å¤„ç†ï¼‰
    â†“
3. å…¨éƒ¨ç”± Uniswap å¤„ç†
```

---

## ä»£ç ç¤ºä¾‹ä¸å›¾è§£

### ç¤ºä¾‹ 1: è´¹ç”¨å……è¶³çš„æƒ…å†µ

```solidity
// å‡è®¾å‚æ•°
ç”¨æˆ·éœ€æ±‚: 100 Tokenï¼ˆamountSpecified = 100ï¼‰
è´¹ç”¨æ± : amount1 = 150 Token
å½“å‰ä»·æ ¼: 1 Token = 0.01 ETH

// _internalSwap() æ‰§è¡Œ
amountSpecified = min(100, 150) = 100 Token

// è®¡ç®—éœ€è¦å¤šå°‘ ETH
ethIn = 100 Token * 0.01 ETH = 1 ETH
tokenOut = 100 Token

// æ›´æ–°è´¹ç”¨æ± 
amount0 += 1 ETH
amount1 -= 100 Token

// ç»“æœ
è´¹ç”¨æ± : amount0 = 1 ETH, amount1 = 50 Token
ç”¨æˆ·: è·å¾— 100 Tokenï¼Œæ”¯ä»˜ 1 ETH
Uniswap: ä¸éœ€è¦å¤„ç†ï¼ˆå…¨éƒ¨ç”±å†…éƒ¨äº¤æ¢æä¾›ï¼‰
```

### ç¤ºä¾‹ 2: è´¹ç”¨ä¸è¶³çš„æƒ…å†µ

```solidity
// å‡è®¾å‚æ•°
ç”¨æˆ·éœ€æ±‚: 100 Token
è´¹ç”¨æ± : amount1 = 50 Token
å½“å‰ä»·æ ¼: 1 Token = 0.01 ETH

// _internalSwap() æ‰§è¡Œ
amountSpecified = min(100, 50) = 50 Token

// è®¡ç®—
ethIn = 50 Token * 0.01 ETH = 0.5 ETH
tokenOut = 50 Token

// æ›´æ–°è´¹ç”¨æ± 
amount0 += 0.5 ETH
amount1 -= 50 Token

// ç»“æœ
è´¹ç”¨æ± : amount0 = 0.5 ETH, amount1 = 0 Token
ç”¨æˆ·: ä»å†…éƒ¨äº¤æ¢è·å¾— 50 Tokenï¼Œæ”¯ä»˜ 0.5 ETH
Uniswap: éœ€è¦æä¾›å‰©ä½™ 50 Tokenï¼Œç”¨æˆ·å†æ”¯ä»˜ 0.5 ETH
```

### ç¤ºä¾‹ 3: è´Ÿæ•° amountSpecified

```solidity
// å‡è®¾å‚æ•°
ç”¨æˆ·æƒ³èŠ±: 1 ETHï¼ˆamountSpecified = -1 ETHï¼‰
è´¹ç”¨æ± : amount1 = 50 Token
å½“å‰ä»·æ ¼: 1 Token = 0.01 ETH

// _internalSwap() æ‰§è¡Œ
// è®¡ç®—èƒ½è·å¾—å¤šå°‘ Token
tokenOut = 1 ETH / 0.01 ETH = 100 Token

// æ£€æŸ¥æ˜¯å¦è¶…è¿‡å¯ç”¨è´¹ç”¨
if (100 Token > 50 Token) {
    // æŒ‰æ¯”ä¾‹å‡å°‘
    ethIn = (50 Token * 1 ETH) / 100 Token = 0.5 ETH
    tokenOut = 50 Token
}

// æ›´æ–°è´¹ç”¨æ± 
amount0 += 0.5 ETH
amount1 -= 50 Token

// ç»“æœ
ç”¨æˆ·: ä»å†…éƒ¨äº¤æ¢è·å¾— 50 Tokenï¼Œæ”¯ä»˜ 0.5 ETH
Uniswap: éœ€è¦æä¾›å‰©ä½™ 50 Tokenï¼Œç”¨æˆ·å†æ”¯ä»˜ 0.5 ETH
```

### å¯è§†åŒ–å›¾è§£

#### æ­£å¸¸äº¤æ¢ vs å†…éƒ¨äº¤æ¢

```
æ­£å¸¸äº¤æ¢ï¼ˆæ—  InternalSwapPoolï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç”¨æˆ·éœ€æ±‚: 100 Token              â”‚
â”‚                                  â”‚
â”‚ ç›´æ¥è¿›å…¥ Uniswap æ±               â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ æ± æµåŠ¨æ€§: 1000 Token         â”‚ â”‚
â”‚ â”‚ ä»·æ ¼å½±å“: è¾ƒå¤§               â”‚ â”‚
â”‚ â”‚ Gas æ¶ˆè€—: è¾ƒé«˜               â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ä½¿ç”¨ InternalSwapPoolï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç”¨æˆ·éœ€æ±‚: 100 Token              â”‚
â”‚                                  â”‚
â”‚ æ­¥éª¤ 1: InternalSwapPool        â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ è´¹ç”¨æ± : 50 Token            â”‚ â”‚
â”‚ â”‚ æä¾›: 50 Token              â”‚ â”‚
â”‚ â”‚ ä»·æ ¼å½±å“: æ— ï¼ˆå†…éƒ¨å¤„ç†ï¼‰     â”‚ â”‚
â”‚ â”‚ Gas æ¶ˆè€—: è¾ƒä½             â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                  â”‚
â”‚ æ­¥éª¤ 2: Uniswap æ±               â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ å‰©ä½™éœ€æ±‚: 50 Token          â”‚ â”‚
â”‚ â”‚ ä»·æ ¼å½±å“: è¾ƒå°ï¼ˆéœ€æ±‚å‡åŠï¼‰   â”‚ â”‚
â”‚ â”‚ Gas æ¶ˆè€—: æ­£å¸¸              â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### è´¹ç”¨è½¬æ¢è¿‡ç¨‹

```
åˆå§‹çŠ¶æ€ï¼š
è´¹ç”¨æ± 
â”œâ”€ amount0: 0 ETH
â””â”€ amount1: 100 Tokenï¼ˆç´¯ç§¯çš„æ‰‹ç»­è´¹ï¼‰

ç”¨æˆ·è´­ä¹° 50 Tokenï¼š
    â†“
å†…éƒ¨äº¤æ¢
â”œâ”€ ç”¨æˆ·æ”¯ä»˜: 0.5 ETH
â””â”€ ç”¨æˆ·è·å¾—: 50 Token
    â†“
è´¹ç”¨æ± æ›´æ–°
â”œâ”€ amount0: 0 + 0.5 = 0.5 ETH
â””â”€ amount1: 100 - 50 = 50 Token

æ•ˆæœï¼š
âœ… Memecoin è´¹ç”¨è½¬æ¢ä¸º ETH
âœ… æ— éœ€é¢å¤–æŠ›å”®æ“ä½œ
âœ… å¯¹ä»·æ ¼å½±å“æœ€å°
```

#### å®Œæ•´äº¤æ˜“æµç¨‹

```
ç”¨æˆ·å‘èµ·äº¤æ˜“ï¼ˆè´­ä¹° 100 Tokenï¼‰
    â”‚
    â”œâ”€ [InternalSwapPool]
    â”‚   â”œâ”€ æ£€æŸ¥è´¹ç”¨æ± : 50 Token å¯ç”¨
    â”‚   â”œâ”€ æä¾›: 50 Token
    â”‚   â”œâ”€ ç”¨æˆ·æ”¯ä»˜: 0.5 ETH
    â”‚   â””â”€ æ›´æ–° beforeSwapDelta
    â”‚
    â”œâ”€ [Uniswap V4]
    â”‚   â”œâ”€ å‰©ä½™éœ€æ±‚: 50 Token
    â”‚   â”œâ”€ ç”¨æˆ·æ”¯ä»˜: 0.5 ETH
    â”‚   â””â”€ æ‰§è¡Œäº¤æ¢
    â”‚
    â””â”€ ç”¨æˆ·è·å¾—: 100 Token
       ç”¨æˆ·æ”¯ä»˜: 1 ETHï¼ˆ0.5 + 0.5ï¼‰
```

---

## å…³é”®æœºåˆ¶æ·±å…¥ç†è§£

### 1. BeforeSwapDelta çš„ä½œç”¨

#### åœ¨ PositionManager ä¸­çš„ä½¿ç”¨

```solidity
(uint tokenIn, uint tokenOut) = _internalSwap(...);

if (tokenIn + tokenOut != 0) {
    // åˆ›å»ºå†…éƒ¨äº¤æ¢çš„ delta
    BeforeSwapDelta internalBeforeSwapDelta = _params.amountSpecified >= 0
        ? toBeforeSwapDelta(-tokenOut.toInt128(), tokenIn.toInt128())
        : toBeforeSwapDelta(tokenIn.toInt128(), -tokenOut.toInt128());
    
    // åˆå¹¶åˆ°æ€» delta
    beforeSwapDelta_ = toBeforeSwapDelta(
        beforeSwapDelta_.getSpecifiedDelta() + internalBeforeSwapDelta.getSpecifiedDelta(),
        beforeSwapDelta_.getUnspecifiedDelta() + internalBeforeSwapDelta.getUnspecifiedDelta() + swapFee.toInt128()
    );
}
```

**å…³é”®ç†è§£**ï¼š

- `BeforeSwapDelta` å‘Šè¯‰ Uniswap å·²ç»å¤„ç†äº†å¤šå°‘
- è´Ÿæ•°è¡¨ç¤º"å·²æä¾›"ï¼ˆç»™ç”¨æˆ·ï¼‰
- æ­£æ•°è¡¨ç¤º"å·²æ¶ˆè€—"ï¼ˆä»ç”¨æˆ·ï¼‰
- Uniswap ä¼šæ ¹æ®è¿™ä¸ª delta è°ƒæ•´åç»­äº¤æ¢

#### ç¤ºä¾‹

```solidity
ç”¨æˆ·éœ€æ±‚: 100 Tokenï¼ˆamountSpecified = 100ï¼‰
å†…éƒ¨äº¤æ¢æä¾›: 50 Token

BeforeSwapDelta:
â”œâ”€ specifiedDelta: -50ï¼ˆå·²æä¾› 50 Tokenï¼‰
â””â”€ unspecifiedDelta: +0.5ï¼ˆå·²æ¶ˆè€— 0.5 ETHï¼‰

Uniswap çœ‹åˆ°ï¼š
â”œâ”€ å‰©ä½™éœ€æ±‚: 100 - 50 = 50 Token
â””â”€ éœ€è¦æ”¯ä»˜: 0.5 ETHï¼ˆä»ç”¨æˆ·ï¼‰
```

### 2. ä¸ºä»€ä¹ˆä½¿ç”¨ SwapMath.computeSwapStepï¼Ÿ

#### SwapMath çš„ä½œç”¨

`SwapMath.computeSwapStep` æ˜¯ Uniswap çš„æ ¸å¿ƒæ•°å­¦åº“ï¼Œç”¨äºè®¡ç®—å•æ­¥äº¤æ¢ã€‚

**ä¼˜åŠ¿**ï¼š

1. **ä»·æ ¼ä¸€è‡´æ€§**ï¼šä½¿ç”¨ä¸ä¸»æ± ç›¸åŒçš„ä»·æ ¼è®¡ç®—
2. **å‡†ç¡®æ€§**ï¼šè€ƒè™‘äº†æµåŠ¨æ€§ã€ä»·æ ¼æ›²çº¿ç­‰å› ç´ 
3. **æ— æ‰‹ç»­è´¹**ï¼š`feePips: 0`ï¼Œç»™ç”¨æˆ·æ›´ä¼˜æƒ çš„ä»·æ ¼

#### è®¡ç®—ç¤ºä¾‹

```solidity
// å‡è®¾
å½“å‰ä»·æ ¼: sqrtPriceX96 = 1000
æµåŠ¨æ€§: 1000000
éœ€æ±‚: 50 Token

// computeSwapStep è®¡ç®—
// è€ƒè™‘ä»·æ ¼æ›²çº¿ã€æµåŠ¨æ€§ç­‰å› ç´ 
// è¿”å›ç²¾ç¡®çš„ ETH éœ€æ±‚
ethIn = computeSwapStep(...)
```

### 3. è´¹ç”¨æ± çš„ç´¯ç§¯å’Œæ¶ˆè€—

#### ç´¯ç§¯è¿‡ç¨‹

```
æ¯æ¬¡äº¤æ˜“æ•è·æ‰‹ç»­è´¹
    â†“
_depositFees() å­˜å…¥è´¹ç”¨æ± 
    â”œâ”€ amount0 += ETH æ‰‹ç»­è´¹
    â””â”€ amount1 += Memecoin æ‰‹ç»­è´¹
    â†“
è´¹ç”¨æ± ç´¯ç§¯
```

#### æ¶ˆè€—è¿‡ç¨‹

```
ç”¨æˆ·è´­ä¹° Memecoin
    â†“
_internalSwap() ä»è´¹ç”¨æ± æä¾›
    â”œâ”€ amount0 += ethInï¼ˆETH å¢åŠ ï¼‰
    â””â”€ amount1 -= tokenOutï¼ˆMemecoin å‡å°‘ï¼‰
    â†“
è´¹ç”¨æ± è½¬æ¢ï¼ˆMemecoin â†’ ETHï¼‰
```

#### å¹³è¡¡æœºåˆ¶

```
ç†æƒ³çŠ¶æ€ï¼š
â”œâ”€ Memecoin è´¹ç”¨è¢«ç”¨æˆ·è´­ä¹°æ¶ˆè€—
â”œâ”€ è½¬æ¢ä¸º ETH è´¹ç”¨
â””â”€ ETH è´¹ç”¨ç”¨äºåˆ†é…

å®é™…çŠ¶æ€ï¼š
â”œâ”€ å¦‚æœè´­ä¹°éœ€æ±‚å¤§ï¼šMemecoin å¿«é€Ÿæ¶ˆè€—
â”œâ”€ å¦‚æœè´­ä¹°éœ€æ±‚å°ï¼šMemecoin ç´¯ç§¯
â””â”€ é€šè¿‡ _distributeFees() å®šæœŸåˆ†é… ETH
```

---

## ä¸ PositionManager çš„é›†æˆ

### åœ¨ beforeSwap ä¸­çš„è°ƒç”¨

```solidity
// PositionManager.beforeSwap()
function beforeSwap(...) {
    // ... å¤„ç† FairLaunch ...
    
    // [ISP] å†…éƒ¨äº¤æ¢æ± å¤„ç†
    (uint tokenIn, uint tokenOut) = _internalSwap(
        poolManager, 
        _key, 
        _params, 
        nativeToken == Currency.unwrap(_key.currency0)
    );
    
    if (tokenIn + tokenOut != 0) {
        // åˆ›å»ºå†…éƒ¨äº¤æ¢çš„ delta
        BeforeSwapDelta internalBeforeSwapDelta = ...;
        
        // æ•è·å†…éƒ¨äº¤æ¢çš„è´¹ç”¨
        uint swapFee = _captureAndDepositFees(...);
        
        // åˆå¹¶åˆ°æ€» delta
        beforeSwapDelta_ = ...;
    }
    
    // ... ç»§ç»­ Uniswap äº¤æ¢ ...
}
```

### åœ¨ afterSwap ä¸­çš„è´¹ç”¨åˆ†é…

```solidity
// PositionManager.afterSwap()
function afterSwap(...) {
    // ... æ•è· Uniswap äº¤æ¢çš„è´¹ç”¨ ...
    
    // [ISP] åˆ†é…è´¹ç”¨
    _distributeFees(_key);
    // è¿™ä¼šæ£€æŸ¥è´¹ç”¨æ± ä¸­çš„ ETHï¼ˆamount0ï¼‰
    // å¦‚æœè¾¾åˆ°é˜ˆå€¼ï¼Œåˆ†é…ç»™å„ä¸ªæ¥æ”¶è€…
}
```

---

## æ€»ç»“

### æ ¸å¿ƒè¦ç‚¹

1. **å‰ç½®å¡«å……æœºåˆ¶**ï¼šåœ¨ Uniswap äº¤æ¢ä¹‹å‰å¤„ç†éƒ¨åˆ†éœ€æ±‚
2. **å‡å°‘ä»·æ ¼å†²å‡»**ï¼šé™ä½å¯¹ä¸»æ± çš„å½±å“
3. **Gas ä¼˜åŒ–**ï¼šå†…éƒ¨å¤„ç†æ›´çœ gas
4. **è´¹ç”¨è½¬æ¢**ï¼šMemecoin è´¹ç”¨è‡ªåŠ¨è½¬æ¢ä¸º ETH
5. **éƒ¨åˆ†å¡«å……**ï¼šåªå¡«å……éƒ¨åˆ†éœ€æ±‚ï¼Œä¸å…¨éƒ¨æ»¡è¶³

### è®¾è®¡ä¼˜åŠ¿

1. **ç”¨æˆ·ä½“éªŒ**ï¼šå‡å°‘æ»‘ç‚¹ï¼Œé™ä½äº¤æ˜“æˆæœ¬
2. **æ± å¥åº·**ï¼šå‡å°‘å¯¹ä¸»æ± çš„å†²å‡»
3. **è´¹ç”¨æ•ˆç‡**ï¼šè‡ªåŠ¨è½¬æ¢ï¼Œæ— éœ€é¢å¤–æ“ä½œ
4. **Gas æ•ˆç‡**ï¼šå†…éƒ¨å¤„ç†æ›´çœ gas

### å­¦ä¹ å»ºè®®

1. **ç†è§£å‰ç½®æœºåˆ¶**ï¼šä¸ºä»€ä¹ˆåœ¨ beforeSwap ä¸­å¤„ç†
2. **ç†è§£éƒ¨åˆ†å¡«å……**ï¼šä¸ºä»€ä¹ˆåªå¡«å……éƒ¨åˆ†éœ€æ±‚
3. **ç†è§£è´¹ç”¨è½¬æ¢**ï¼šMemecoin å¦‚ä½•è½¬æ¢ä¸º ETH
4. **ç†è§£ BeforeSwapDelta**ï¼šå¦‚ä½•ä¸ Uniswap äº¤äº’

---

**å¸Œæœ›è¿™ä»½æ–‡æ¡£èƒ½å¸®åŠ©ä½ æ·±å…¥ç†è§£ InternalSwapPool çš„å®ç°åŸç†ï¼** ğŸš€

